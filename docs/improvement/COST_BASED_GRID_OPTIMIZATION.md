# åŸºäºŽæˆæœ¬ä»·çš„ç½‘æ ¼äº¤æ˜“ç­–ç•¥ä¼˜åŒ–

## æ¦‚è¿°

æœ¬æ¬¡ä¼˜åŒ–è§£å†³äº†ç½‘æ ¼äº¤æ˜“ç­–ç•¥ä¸­çš„ä¸€ä¸ªå…³é”®é—®é¢˜ï¼š**å–å•ä»·æ ¼è®¾ç½®åº”è¯¥åŸºäºŽæˆæœ¬ä»·è€Œä¸æ˜¯å¸‚ä»·**ï¼Œç¡®ä¿æ¯ç¬”äº¤æ˜“éƒ½èƒ½å®žçŽ°ç›ˆåˆ©ã€‚

## é—®é¢˜åˆ†æž

### åŽŸæœ‰é—®é¢˜
1. **ä¹°å•ä»·æ ¼è®¾ç½®**ï¼šåŸºäºŽå½“å‰å¸‚ä»·é€’å‡è®¾ç½® âœ… (è¿™æ˜¯æ­£ç¡®çš„)
2. **å–å•ä»·æ ¼è®¾ç½®**ï¼šåŸºäºŽå½“å‰å¸‚ä»·é€’å¢žè®¾ç½® âŒ (è¿™æ˜¯é”™è¯¯çš„)

### é—®é¢˜å½±å“
- å½“å¸‚ä»·ä¸‹è·Œæ—¶ï¼ŒåŸºäºŽå¸‚ä»·è®¾ç½®çš„å–å•å¯èƒ½ä½ŽäºŽæˆæœ¬ä»·
- å¯¼è‡´äºæŸäº¤æ˜“ï¼Œè¿èƒŒç½‘æ ¼ç­–ç•¥çš„ç›ˆåˆ©åŽŸåˆ™
- æ— æ³•ä¿è¯æ¯ä¸ªç½‘æ ¼å±‚éƒ½æœ‰è¶³å¤Ÿçš„åˆ©æ¶¦ç©ºé—´

## ä¼˜åŒ–æ–¹æ¡ˆ

### 1. å–å•ä»·æ ¼ç­–ç•¥ä¼˜åŒ–

#### åŽŸå§‹é€»è¾‘
```rust
// é”™è¯¯ï¼šåŸºäºŽå¸‚ä»·è®¾ç½®å–å•
let mut current_sell_price = current_price;
current_sell_price = current_sell_price + (current_sell_price * dynamic_spacing);
```

#### ä¼˜åŒ–åŽé€»è¾‘
```rust
// æ­£ç¡®ï¼šåŸºäºŽæˆæœ¬ä»·è®¾ç½®å–å•
let mut current_sell_price = if grid_state.position_avg_price > 0.0 {
    // å¦‚æžœæœ‰æŒä»“ï¼ŒåŸºäºŽæˆæœ¬ä»·è®¾ç½®å–å•èµ·å§‹ä»·æ ¼
    let min_profitable_price = calculate_min_sell_price(
        grid_state.position_avg_price,
        grid_config.fee_rate,
        grid_config.min_profit / grid_state.position_avg_price,
    );
    // ç¡®ä¿å–å•ä»·æ ¼ä¸ä½ŽäºŽæœ€å°ç›ˆåˆ©ä»·æ ¼ï¼Œä½†ä¹Ÿä¸è¦è¿‡äºŽåç¦»å¸‚ä»·
    let market_based_price = current_price * 1.005; // å¸‚ä»·ä¸Šæµ®0.5%
    min_profitable_price.max(market_based_price)
} else {
    // å¦‚æžœæ²¡æœ‰æŒä»“ï¼ŒåŸºäºŽå½“å‰å¸‚ä»·è®¾ç½®
    current_price * 1.005 // å¸‚ä»·ä¸Šæµ®0.5%
};
```

### 2. é—´è·è®¡ç®—ä¼˜åŒ–

#### åŸºäºŽæˆæœ¬ä»·çš„é—´è·ç­–ç•¥
```rust
let spacing_increment = if grid_state.position_avg_price > 0.0 {
    // æœ‰æŒä»“æ—¶ï¼šåŸºäºŽæˆæœ¬ä»·è®¡ç®—é—´è·ï¼Œç¡®ä¿æ¯å±‚éƒ½æœ‰è¶³å¤Ÿåˆ©æ¶¦
    let cost_based_spacing = grid_state.position_avg_price * dynamic_spacing;
    cost_based_spacing.max(grid_state.position_avg_price * 0.002) // æœ€å°0.2%é—´è·
} else {
    // æ— æŒä»“æ—¶ï¼šåŸºäºŽå¸‚ä»·è®¡ç®—é—´è·
    current_sell_price * dynamic_spacing
};
```

### 3. ä¸¥æ ¼åˆ©æ¶¦éªŒè¯

#### å¢žå¼ºçš„åˆ©æ¶¦æ£€æŸ¥
```rust
// ä¸¥æ ¼éªŒè¯åˆ©æ¶¦è¦æ±‚ - åŸºäºŽæˆæœ¬ä»·
if grid_state.position_avg_price > 0.0 {
    let actual_profit_rate = calculate_expected_profit_rate(
        grid_state.position_avg_price,
        current_sell_price,
        grid_config.fee_rate,
    );
    let min_required_profit_rate = grid_config.min_profit / grid_state.position_avg_price;
    
    if actual_profit_rate < min_required_profit_rate {
        // å¦‚æžœåˆ©æ¶¦ä¸è¶³ï¼Œè°ƒæ•´ä»·æ ¼åˆ°æœ€å°ç›ˆåˆ©è¦æ±‚
        let min_required_price = calculate_min_sell_price(
            grid_state.position_avg_price,
            grid_config.fee_rate,
            min_required_profit_rate,
        );
        current_sell_price = min_required_price;
    }
}
```

## æ ¸å¿ƒæ”¹è¿›

### 1. æ™ºèƒ½ä»·æ ¼èµ·ç‚¹
- **æœ‰æŒä»“æ—¶**ï¼šåŸºäºŽæŒä»“æˆæœ¬ä»·è®¾ç½®å–å•èµ·å§‹ä»·æ ¼
- **æ— æŒä»“æ—¶**ï¼šåŸºäºŽå¸‚ä»·è®¾ç½®ï¼Œä¸ºåŽç»­å»ºä»“åšå‡†å¤‡

### 2. æˆæœ¬ä»·ä¿æŠ¤
- æ‰€æœ‰å–å•ä»·æ ¼éƒ½ä¸ä¼šä½ŽäºŽæˆæœ¬ä»· + æœ€å°åˆ©æ¶¦è¦æ±‚
- è‡ªåŠ¨è°ƒæ•´ä»·æ ¼ç¡®ä¿æ¯ç¬”äº¤æ˜“éƒ½æœ‰åˆ©æ¶¦

### 3. åŠ¨æ€é—´è·è°ƒæ•´
- åŸºäºŽæˆæœ¬ä»·è®¡ç®—ç½‘æ ¼é—´è·ï¼Œè€Œä¸æ˜¯å¸‚ä»·
- ç¡®ä¿æ¯ä¸ªç½‘æ ¼å±‚éƒ½æœ‰åˆç†çš„åˆ©æ¶¦ç©ºé—´

### 4. è¯¦ç»†æ—¥å¿—è®°å½•
- è®°å½•æˆæœ¬ä»·ã€å–å‡ºä»·ã€é¢„æœŸåˆ©æ¶¦çŽ‡
- ä¾¿äºŽç›‘æŽ§å’Œè°ƒè¯•ç­–ç•¥æ‰§è¡Œæƒ…å†µ

## å®žé™…æ•ˆæžœ

### ä¼˜åŒ–å‰
```
ðŸ”„ å¼€å§‹å–å•å¾ªçŽ¯ - åˆå§‹å–å‡ºä»·: 1.3720, ä»·æ ¼ä¸Šé™: 1.6464, æœ€å¤§æ•°é‡: 100.0, æœ€å¤§å–å•æ•°: 10
```

### ä¼˜åŒ–åŽ
```
ðŸ”„ å¼€å§‹å–å•å¾ªçŽ¯ - åˆå§‹å–å‡ºä»·: 1.3850 (åŸºäºŽæˆæœ¬ä»·: 1.3800), ä»·æ ¼ä¸Šé™: 1.6464, æœ€å¤§æ•°é‡: 100.0, æœ€å¤§å–å•æ•°: 10
âœ… å–å•åˆ©æ¶¦éªŒè¯é€šè¿‡ - æˆæœ¬ä»·: 1.3800, å–å‡ºä»·: 1.3850, åˆ©æ¶¦çŽ‡: 2.89%
ðŸ“ˆ è°ƒæ•´å–å•ä»·æ ¼ç¡®ä¿ç›ˆåˆ© - æˆæœ¬ä»·: 1.3800, è°ƒæ•´åŽä»·æ ¼: 1.3920, é¢„æœŸåˆ©æ¶¦çŽ‡: 3.50%
```

## é…å¥—åŠŸèƒ½

### 1. ä¹°å•æˆäº¤å¤„ç†
- `handle_buy_fill` å‡½æ•°å·²ç»å®žçŽ°äº†åŸºäºŽæˆæœ¬ä»·çš„å¯¹å†²å–å•åˆ›å»º
- ç¡®ä¿ä¹°å•æˆäº¤åŽç«‹å³åˆ›å»ºç›ˆåˆ©çš„å–å•

### 2. åˆ©æ¶¦è®¡ç®—å‡½æ•°
- `calculate_min_sell_price`: è®¡ç®—æœ€å°ç›ˆåˆ©å–å‡ºä»·
- `calculate_expected_profit_rate`: è®¡ç®—é¢„æœŸåˆ©æ¶¦çŽ‡

### 3. é£Žé™©æŽ§åˆ¶
- ä»·æ ¼ä¸ä¼šè¿‡åº¦åç¦»å¸‚ä»·ï¼ˆæœ€å¤šåç¦»0.5%ï¼‰
- ä¿æŒç½‘æ ¼ç­–ç•¥çš„å¸‚åœºé€‚åº”æ€§

## æ€»ç»“

è¿™æ¬¡ä¼˜åŒ–ç¡®ä¿äº†ç½‘æ ¼äº¤æ˜“ç­–ç•¥çš„æ ¸å¿ƒåŽŸåˆ™ï¼š
1. **æ¯ç¬”äº¤æ˜“éƒ½æœ‰åˆ©æ¶¦**ï¼šå–å•ä»·æ ¼åŸºäºŽæˆæœ¬ä»·è®¾ç½®
2. **é£Žé™©å¯æŽ§**ï¼šä»·æ ¼è°ƒæ•´æœ‰åˆç†èŒƒå›´
3. **ç­–ç•¥ä¸€è‡´æ€§**ï¼šä¹°å•å’Œå–å•é€»è¾‘åè°ƒç»Ÿä¸€
4. **å¯ç›‘æŽ§æ€§**ï¼šè¯¦ç»†çš„æ—¥å¿—è®°å½•ä¾¿äºŽåˆ†æž

é€šè¿‡è¿™äº›æ”¹è¿›ï¼Œç½‘æ ¼ç­–ç•¥èƒ½å¤Ÿæ›´å¥½åœ°ä¿æŠ¤èµ„é‡‘å®‰å…¨ï¼Œç¡®ä¿åœ¨å„ç§å¸‚åœºæ¡ä»¶ä¸‹éƒ½èƒ½å®žçŽ°ç¨³å®šç›ˆåˆ©ã€‚ 